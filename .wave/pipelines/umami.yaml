kind: WavePipeline
metadata:
    name: umami-analytics-action-plan
    description: Analyze last 30 days of Umami analytics, compare to historical data, and generate action plans
input:
    source: meta
steps:
    - id: navigate-umami-access
      persona: navigator
      memory:
        strategy: fresh
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
            Analyze how to access Umami analytics data. Focus on:
            1. Identify Umami API endpoints or data export methods
            2. Determine authentication requirements
            3. Find what metrics are available (page views, visitors, events, etc.)
            4. Identify date range query parameters

            Output a structured JSON analysis to artifact.json with:
            - api_endpoints: array of endpoint objects with path and purpose
            - auth_method: string describing authentication approach
            - available_metrics: array of metric names
            - query_params: object with date filtering options

            CRITICAL: You MUST create an artifact.json file with your analysis - this overrides the normal no-write constraint for pipeline data flow.
      output_artifacts:
        - name: umami-access
          path: artifact.json
          type: json
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/umami-access.schema.json
    - id: fetch-current-analytics
      persona: implementer
      dependencies:
        - navigate-umami-access
      memory:
        strategy: fresh
        inject_artifacts:
            - step: navigate-umami-access
              artifact: umami-access
              as: umami-access
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
            Fetch the last 30 days of Umami analytics data.

            Read the Umami access configuration from artifacts/umami-access to understand the API structure.

            Tasks:
            1. Query Umami API for the last 30 days of data
            2. Collect key metrics: page views, unique visitors, bounce rate, session duration, top pages, referrers
            3. Structure the data for analysis

            Save the fetched analytics data to artifact.json with:
            - date_range: object with start and end dates
            - metrics: object containing all collected metrics
            - top_pages: array of page performance objects
            - traffic_sources: array of referrer data
            - raw_data_summary: summary statistics

            CRITICAL: You MUST create an artifact.json file - this overrides normal constraints for pipeline data flow.
      output_artifacts:
        - name: current-analytics
          path: artifact.json
          type: json
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/analytics-data.schema.json
    - id: fetch-historical-analytics
      persona: implementer
      dependencies:
        - navigate-umami-access
      memory:
        strategy: fresh
        inject_artifacts:
            - step: navigate-umami-access
              artifact: umami-access
              as: umami-access
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
            Fetch historical Umami analytics data for comparison (31-90 days ago).

            Read the Umami access configuration from artifacts/umami-access to understand the API structure.

            Tasks:
            1. Query Umami API for data from 31-90 days ago (previous 60-day period)
            2. Collect the same key metrics as current period for fair comparison
            3. Structure the data identically to enable direct comparison

            Save the fetched analytics data to artifact.json with:
            - date_range: object with start and end dates
            - metrics: object containing all collected metrics
            - top_pages: array of page performance objects
            - traffic_sources: array of referrer data
            - raw_data_summary: summary statistics

            CRITICAL: You MUST create an artifact.json file - this overrides normal constraints for pipeline data flow.
      output_artifacts:
        - name: historical-analytics
          path: artifact.json
          type: json
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/analytics-data.schema.json
    - id: compare-analytics
      persona: philosopher
      dependencies:
        - fetch-current-analytics
        - fetch-historical-analytics
      memory:
        strategy: fresh
        inject_artifacts:
            - step: fetch-current-analytics
              artifact: current-analytics
              as: current-analytics
            - step: fetch-historical-analytics
              artifact: historical-analytics
              as: historical-analytics
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
            Compare current analytics (last 30 days) against historical data (31-90 days ago).

            Read the current analytics from artifacts/current-analytics.
            Read the historical analytics from artifacts/historical-analytics.

            Perform comprehensive analysis:
            1. Calculate percentage changes for all key metrics
            2. Identify significant trends (positive and negative)
            3. Detect anomalies or unusual patterns
            4. Highlight top performing and declining pages
            5. Analyze traffic source changes
            6. Identify seasonal or cyclical patterns if apparent

            Save your comparison analysis to artifact.json with:
            - summary: high-level findings object
            - metric_changes: array of metric comparison objects with deltas
            - trends: array of identified trend objects
            - anomalies: array of anomaly objects
            - page_performance: object with winners and losers arrays
            - traffic_analysis: object analyzing source changes
            - key_insights: array of actionable insight strings

            CRITICAL: You MUST create an artifact.json file - this overrides normal constraints for pipeline data flow.
      output_artifacts:
        - name: comparison-report
          path: artifact.json
          type: json
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/comparison-report.schema.json
    - id: generate-action-plans
      persona: philosopher
      dependencies:
        - compare-analytics
      memory:
        strategy: fresh
        inject_artifacts:
            - step: compare-analytics
              artifact: comparison-report
              as: comparison-report
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
            Generate actionable plans based on analytics comparison.

            Read the comparison report from artifacts/comparison-report.

            Create prioritized action plans addressing:
            1. Quick wins - immediate actions with high impact
            2. Content optimization - pages needing improvement
            3. Traffic acquisition - strategies to improve declining sources
            4. Conversion optimization - if bounce rate or engagement metrics declined
            5. Technical improvements - if performance issues detected
            6. Long-term strategic initiatives

            For each action plan include:
            - Clear objective
            - Specific tasks
            - Expected impact
            - Priority level
            - Success metrics

            Save the action plans to artifact.json with:
            - executive_summary: brief overview string
            - quick_wins: array of immediate action objects
            - content_actions: array of content improvement objects
            - traffic_actions: array of traffic acquisition objects
            - optimization_actions: array of conversion/engagement objects
            - strategic_initiatives: array of long-term initiative objects
            - implementation_timeline: suggested phasing object
            - kpis: array of key performance indicators to track

            CRITICAL: You MUST create an artifact.json file - this overrides normal constraints for pipeline data flow.
      output_artifacts:
        - name: action-plans
          path: artifact.json
          type: json
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/action-plans.schema.json
    - id: review-and-finalize
      persona: reviewer
      dependencies:
        - generate-action-plans
        - compare-analytics
      memory:
        strategy: fresh
        inject_artifacts:
            - step: generate-action-plans
              artifact: action-plans
              as: action-plans
            - step: compare-analytics
              artifact: comparison-report
              as: comparison-report
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
            Review and finalize the analytics action plans.

            Read the action plans from artifacts/action-plans.
            Read the comparison report from artifacts/comparison-report for context.

            Review criteria:
            1. Are action plans grounded in the actual data?
            2. Are priorities correctly assigned based on impact?
            3. Are success metrics measurable and realistic?
            4. Are there any gaps or missing opportunities?
            5. Is the implementation timeline realistic?

            Provide final reviewed document with:
            - Any adjustments or refinements to action plans
            - Risk assessment for each major initiative
            - Resource requirements estimation
            - Final prioritized roadmap

            Save the final report to artifact.json with:
            - review_summary: overall assessment string
            - data_validation: object confirming plans match data
            - adjusted_plans: refined action plans object
            - risk_assessment: array of risk objects per initiative
            - resource_requirements: object with estimates
            - final_roadmap: prioritized list of actions with sequence
            - next_review_date: suggested follow-up date string

            CRITICAL: You MUST create an artifact.json file - this overrides normal constraints for pipeline data flow.
      output_artifacts:
        - name: final-report
          path: artifact.json
          type: json
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/final-report.schema.json
