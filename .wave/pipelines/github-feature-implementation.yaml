kind: WavePipeline
metadata:
  name: github-feature-implementation
  description: "Production pipeline to implement features from GitHub issues and create PRs"

input:
  source: cli
  schema:
    type: object
    required: [repo, issue]
    properties:
      repo:
        type: string
        description: "GitHub repository in owner/name format"
        pattern: "^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$"
      issue:
        type: integer
        description: "GitHub issue number to implement"
        minimum: 1
      base_branch:
        type: string
        description: "Base branch for PR (default: main)"
        default: "main"

steps:
  - id: analyze-requirement
    persona: navigator
    memory:
      strategy: fresh
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Analyze the GitHub issue for implementation requirements.

        Repository: {{ input.repo }}
        Issue: #{{ input.issue }}

        Tasks:
        1. Fetch the issue details using gh CLI
        2. Extract requirements, acceptance criteria, and context
        3. Identify affected components and files
        4. Analyze technical approach needed
        5. Check for related issues or PRs
        6. List dependencies and prerequisites

        Commands:
        - gh issue view {{ input.issue }} --repo {{ input.repo }} --json number,title,body,labels,comments,url
        - gh issue view {{ input.issue }} --repo {{ input.repo }} --comments
        - Use git commands to understand repository structure
        - Search codebase for relevant files and patterns

        Output to artifact.json:
        {
          "issue": {
            "number": {{ input.issue }},
            "title": "Feature title",
            "description": "Full description",
            "labels": ["enhancement", "feature"],
            "url": "https://github.com/owner/repo/issues/123"
          },
          "requirements": [
            "Specific requirement 1",
            "Specific requirement 2"
          ],
          "acceptance_criteria": [
            "Criteria 1",
            "Criteria 2"
          ],
          "affected_components": ["component1", "component2"],
          "affected_files": ["path/to/file1.go", "path/to/file2.go"],
          "technical_approach": "High-level approach description",
          "related_issues": [42, 56],
          "related_prs": [89],
          "implementation_complexity": "medium",
          "estimated_changes": "10-50 lines across 3 files"
        }
    output_artifacts:
      - name: requirement_analysis
        path: artifact.json
        type: json
        required: true
    handover:
      contract:
        type: json_schema
        schema_path: .wave/contracts/navigation-analysis.schema.json
        validate: true

  - id: create-feature-branch
    persona: craftsman
    dependencies: [analyze-requirement]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: analyze-requirement
          artifact: requirement_analysis
          as: analysis
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Create a feature branch for implementation.

        Base branch: {{ input.base_branch | default: "main" }}
        Issue number: {{ input.issue }}

        Tasks:
        1. Ensure git repository is in clean state
        2. Fetch latest changes from remote
        3. Create a feature branch with clear naming: feature/issue-{{ input.issue }}-descriptive-name
        4. Push branch to remote to establish tracking

        Commands:
        - git fetch origin
        - git checkout {{ input.base_branch | default: "main" }}
        - git pull origin {{ input.base_branch | default: "main" }}
        - git checkout -b feature/issue-{{ input.issue }}-[descriptive-slug]
        - git push -u origin feature/issue-{{ input.issue }}-[descriptive-slug]

        Output to artifact.json:
        {
          "branch_name": "feature/issue-123-add-oauth-support",
          "base_branch": "main",
          "created": true,
          "pushed": true,
          "remote_url": "https://github.com/owner/repo/tree/feature/issue-123-add-oauth-support"
        }
    output_artifacts:
      - name: branch_info
        path: artifact.json
        type: json
        required: true

  - id: implement-feature
    persona: craftsman
    dependencies: [create-feature-branch]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: analyze-requirement
          artifact: requirement_analysis
          as: requirements
        - step: create-feature-branch
          artifact: branch_info
          as: branch
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Implement the feature based on requirements analysis.

        CRITICAL IMPLEMENTATION GUIDELINES:
        - Follow existing code patterns and conventions in the repository
        - Add comprehensive error handling
        - Write clear, self-documenting code with comments where needed
        - Ensure backward compatibility
        - Add logging for debugging and monitoring
        - Consider edge cases and validation

        Implementation steps:
        1. Review the requirements and technical approach
        2. Implement changes file by file
        3. Add or update tests for new functionality
        4. Verify code compiles/runs without errors
        5. Run existing test suite to ensure no regressions
        6. Update documentation if needed

        Testing commands (adjust for language):
        - Go: go build ./... && go test ./...
        - Python: python -m pytest
        - JavaScript: npm test
        - Rust: cargo build && cargo test

        Commit changes with clear messages:
        - git add [files]
        - git commit -m "feat: implement [feature] for issue #{{ input.issue }}"
        - git push origin [branch]

        Output to artifact.json:
        {
          "files_changed": ["path/to/file1.go", "path/to/file2_test.go"],
          "files_added": ["path/to/new_file.go"],
          "files_deleted": [],
          "tests_added": true,
          "tests_passed": true,
          "builds_successfully": true,
          "commits": [
            {
              "sha": "abc123",
              "message": "feat: implement OAuth provider support for issue #123"
            }
          ],
          "total_additions": 150,
          "total_deletions": 20,
          "implementation_notes": "Added OAuth2 client with token refresh logic"
        }
    output_artifacts:
      - name: implementation_results
        path: artifact.json
        type: json
        required: true
    handover:
      contract:
        type: json_schema
        schema_path: .wave/contracts/implementation-results.schema.json
        validate: true

  - id: create-pull-request
    persona: github-pr-creator
    dependencies: [implement-feature]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: analyze-requirement
          artifact: requirement_analysis
          as: requirements
        - step: create-feature-branch
          artifact: branch_info
          as: branch
        - step: implement-feature
          artifact: implementation_results
          as: implementation
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Create a comprehensive pull request for the implementation.

        Repository: {{ input.repo }}
        Issue: #{{ input.issue }}
        Branch: [from branch_info]
        Base: {{ input.base_branch | default: "main" }}

        PR Structure:
        1. **Title**: Clear, concise (under 72 chars) - "feat: Add OAuth provider support"
        2. **Body**:
           ## Summary
           [2-3 sentence overview]

           ## Changes
           - List specific changes made
           - Include file changes and key additions

           ## Implementation Notes
           - Technical decisions and approach
           - Any trade-offs or considerations

           ## Testing
           - How to test the changes
           - Test coverage added
           - Manual testing steps

           ## Related Issues
           Closes #{{ input.issue }}

           ## Checklist
           - [x] Tests added/updated
           - [x] Documentation updated
           - [x] Code follows project conventions
           - [x] All tests passing
           - [ ] Ready for review

        Commands:
        - gh pr create --repo {{ input.repo }} \
            --title "feat: [title]" \
            --body "$(cat <<'EOF'
          [body content]
          EOF
          )" \
            --base {{ input.base_branch | default: "main" }} \
            --head [branch-name]
        - Suggest reviewers if appropriate
        - Add labels: enhancement, ready-for-review

        Output to artifact.json:
        {
          "pr_number": 456,
          "pr_url": "https://github.com/owner/repo/pull/456",
          "title": "feat: Add OAuth provider support",
          "state": "open",
          "base": "main",
          "head": "feature/issue-123-oauth",
          "labels": ["enhancement", "ready-for-review"],
          "closes_issues": [123],
          "created_at": "2026-02-03T10:15:00Z",
          "success": true
        }
    output_artifacts:
      - name: pr_info
        path: artifact.json
        type: json
        required: true
    handover:
      contract:
        type: json_schema
        schema_path: .wave/contracts/github-pr-info.schema.json
        validate: true
        must_pass: true

  - id: verify-pr
    persona: navigator
    dependencies: [create-pull-request]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: create-pull-request
          artifact: pr_info
          as: pr
        - step: implement-feature
          artifact: implementation_results
          as: implementation
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Verify the pull request was created successfully and is ready for review.

        Verification steps:
        1. Fetch PR details with gh CLI
        2. Verify PR links to issue correctly
        3. Check that all commits are included
        4. Verify CI/CD checks are running (if configured)
        5. Confirm PR description is complete and clear
        6. Check that labels are appropriate

        Commands:
        - gh pr view [pr-number] --repo {{ input.repo }} --json number,title,body,state,labels,commits,url
        - gh pr checks [pr-number] --repo {{ input.repo }}

        Output to artifact.json:
        {
          "pr_number": 456,
          "pr_url": "https://github.com/owner/repo/pull/456",
          "verified": true,
          "verification_details": {
            "links_to_issue": true,
            "all_commits_included": true,
            "description_complete": true,
            "labels_appropriate": true,
            "ci_checks_running": true
          },
          "issues_found": [],
          "ready_for_review": true,
          "summary": "PR #456 successfully created and ready for review. Implements feature from issue #123 with full test coverage."
        }
    output_artifacts:
      - name: verification_report
        path: artifact.json
        type: json
        required: true
    handover:
      contract:
        type: json_schema
        schema_path: .wave/contracts/github-verification-report.schema.json
        validate: true
