kind: WavePipeline
metadata:
  name: dead-code-pr
  description: "Scan for dead code and post findings as a PR comment"
  release: true

requires:
  tools: [gh]

input:
  source: cli
  example: "scan for dead code and comment on PR #42"

steps:
  - id: scan
    persona: navigator
    workspace:
      mount:
        - source: ./
          target: /project
          mode: readonly
    exec:
      type: prompt
      source: |
        Scan for dead or redundant code: {{ input }}

        ## What to Look For

        1. **Unused exports**: Exported functions, types, constants, or variables
           that are never referenced outside their package.

        2. **Unreachable code**: Code after return/panic, impossible branches,
           dead switch cases.

        3. **Orphaned files**: Files not imported by any other file in the project.

        4. **Redundant / duplicate code**: Duplicate functions or copy-paste blocks
           across packages. Functions with identical signatures in different packages.

        5. **Stale tests**: Tests for functions that no longer exist,
           or tests that test nothing meaningful.

        6. **Unused imports**: Imports that are no longer needed.

        7. **Commented-out code**: Large blocks of commented code that
           should be deleted (git has history).

        8. **Stale glue code**: Adapter or wrapper functions that once connected
           components but now have no consumers.

        9. **Hardcoded values**: Magic numbers, hardcoded strings, or configuration
           values that should be extracted to constants, env vars, or config files.

        ## Verification

        For each finding, verify it's truly dead:
        - Grep for all references across the entire codebase
        - Check for reflect-based or string-based usage
        - Check if it's part of an interface implementation
        - Check for build tag conditional compilation

        Produce a structured JSON result matching the contract schema.
        Only include findings with high or medium confidence. Skip low confidence.
    output_artifacts:
      - name: scan_results
        path: .wave/output/dead-code-scan.json
        type: json
    handover:
      contract:
        type: json_schema
        source: .wave/output/dead-code-scan.json
        schema_path: .wave/contracts/dead-code-scan.schema.json
        on_failure: retry
        max_retries: 2

  - id: format
    persona: summarizer
    dependencies: [scan]
    memory:
      inject_artifacts:
        - step: scan
          artifact: scan_results
          as: findings
    exec:
      type: prompt
      source: |
        Transform the raw scan results into a human-readable markdown summary report.

        ## Markdown Body Format

        ```markdown
        ## Summary

        Found **N** potential issues across **M** categories.
        **H** high-confidence findings are safe to remove.

        ## Findings by Category

        ### Unused Exports (X findings)

        | ID | Location | Symbol | Confidence | Action |
        |----|----------|--------|------------|--------|
        | DC-001 | path/file.go:10-25 | FuncName | high | remove |

        ### [Other categories...]

        ## Recommended Actions

        1. **Remove** (N items): ...
        2. **Consolidate** (N items): ...
        3. **Investigate** (N items): ...
        4. **Configure** (N items): ...
        ```

        Produce a JSON report matching the contract schema.
    output_artifacts:
      - name: report
        path: .wave/output/dead-code-report.json
        type: json
    handover:
      contract:
        type: json_schema
        source: .wave/output/dead-code-report.json
        schema_path: .wave/contracts/dead-code-report.schema.json
        on_failure: retry
        max_retries: 2

  - id: publish-pr-comment
    persona: github-commenter
    dependencies: [format]
    memory:
      inject_artifacts:
        - step: format
          artifact: report
          as: report
    exec:
      type: prompt
      source: |
        Post the dead code scan report as a PR comment.

        The original input was: {{ input }}
        Extract the PR number or URL from the input.

        1. Read the report artifact to get the body content
        2. Post it as a PR comment:

           ```bash
           gh pr comment <PR_NUMBER_OR_URL> --body-file .wave/artifacts/report
           ```

        3. Produce a JSON status report matching the contract schema.
    output_artifacts:
      - name: pr-result
        path: .wave/output/pr-result.json
        type: json
    handover:
      contract:
        type: json_schema
        source: .wave/output/pr-result.json
        schema_path: .wave/contracts/dead-code-pr-result.schema.json
        on_failure: retry
        max_retries: 2
    outcomes:
      - type: url
        extract_from: .wave/output/pr-result.json
        json_path: .comment_url
        label: "PR Comment"
