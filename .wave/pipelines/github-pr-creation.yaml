kind: WavePipeline
metadata:
    name: github-pr-creation
    description: Production-ready pipeline to create GitHub pull requests with proper formatting
input:
    source: meta
steps:
    - id: analyze-changes
      persona: navigator
      memory:
        strategy: fresh
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
          Analyze the changes for PR creation based on: {{ input }}

          Use git commands to:
          1. Identify the current branch
          2. Get the diff against the base branch (usually main)
          3. List all changed files
          4. Analyze commit messages for context
          5. Identify related issues or tickets

          Commands to use:
          - git branch --show-current
          - git diff main...HEAD --stat
          - git log main..HEAD --oneline
          - git diff main...HEAD

          Output structured analysis to artifact.json with:
          - current_branch
          - base_branch (usually main)
          - changed_files: array with file paths and change types
          - commit_messages: array of commit messages
          - diff_summary: summary of changes
          - related_issues: extracted issue numbers (#123 patterns)

          This will inform PR creation.
      output_artifacts:
        - name: change_analysis
          path: artifact.json
          type: json
          required: true
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/github-change-analysis.schema.json
            validate: true

    - id: draft-pr
      persona: github-pr-creator
      dependencies:
        - analyze-changes
      memory:
        strategy: fresh
        inject_artifacts:
            - step: analyze-changes
              artifact: change_analysis
              as: changes
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
          Draft a high-quality pull request based on the change analysis.

          Create a PR with:

          1. **Title**: Clear, concise, action-oriented (under 72 chars)
             - Start with verb: Add, Fix, Update, Refactor, etc.
             - Summarize the main change

          2. **Body**: Well-structured with sections:
             - Summary (2-4 sentences)
             - Changes (bulleted list of specific changes)
             - Motivation (why this change is needed)
             - Test Plan (how to test)
             - Checklist (tests, docs, breaking changes)

          3. **Metadata**:
             - Link related issues using "Closes #123" or "Fixes #456"
             - Suggest appropriate labels
             - Recommend reviewers if clear

          Output the PR draft to artifact.json with:
          - title
          - body (markdown formatted)
          - head (source branch)
          - base (target branch, usually main)
          - draft (boolean, true for WIP)
          - labels (array)
          - related_issues (array)

          Make the PR easy to review and understand.
      output_artifacts:
        - name: pr_draft
          path: artifact.json
          type: json
          required: true
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/github-pr-draft.schema.json
            validate: true
            must_pass: true

    - id: create-pr
      persona: github-pr-creator
      dependencies:
        - draft-pr
      memory:
        strategy: fresh
        inject_artifacts:
            - step: draft-pr
              artifact: pr_draft
              as: draft
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
          Create the pull request using GitHub CLI.

          Use the drafted PR information to:
          1. Create the PR with gh pr create
          2. Add labels if specified
          3. Request reviewers if specified
          4. Link to related issues

          Commands:
          - gh pr create --title "title" --body "body" --base main --head branch
          - gh pr edit <number> --add-label "label1,label2"
          - gh pr edit <number> --add-reviewer "user1,user2"

          The body should be passed via heredoc for proper formatting:
          gh pr create --title "Title" --body "$(cat <<'EOF'
          [body content here]
          EOF
          )"

          Output the created PR info to artifact.json with:
          - pr_number
          - pr_url
          - title
          - state
          - created_at
          - success (boolean)

          Include the full PR URL for easy access.
      output_artifacts:
        - name: pr_info
          path: artifact.json
          type: json
          required: true
      handover:
        contract:
            type: json_schema
            schema_path: .wave/contracts/github-pr-info.schema.json
            validate: true
            must_pass: true
        on_review_fail: retry
        max_retries: 2

    - id: verify-pr
      persona: navigator
      dependencies:
        - create-pr
      memory:
        strategy: fresh
        inject_artifacts:
            - step: create-pr
              artifact: pr_info
              as: pr
      workspace:
        root: ./
      exec:
        type: prompt
        source: |
          Verify the pull request was created successfully.

          Use gh pr view to check:
          1. PR exists and is accessible
          2. Title matches what was drafted
          3. Body is properly formatted
          4. Labels were applied
          5. Reviewers were assigned (if applicable)
          6. Related issues are linked

          Command: gh pr view <number> --json title,body,labels,reviewers,state

          Output verification to artifact.json with:
          - pr_number
          - verified (boolean)
          - verification_details (what was checked)
          - issues_found (any problems)
          - pr_url (for quick access)

          Provide a summary of the created PR.
      output_artifacts:
        - name: verification
          path: artifact.json
          type: json
          required: true
