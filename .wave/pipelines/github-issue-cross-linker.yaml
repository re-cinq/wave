kind: WavePipeline
metadata:
  name: github-issue-cross-linker
  description: "Production pipeline to find and link related GitHub issues"

input:
  source: cli
  schema:
    type: object
    required: [repo]
    properties:
      repo:
        type: string
        description: "GitHub repository in owner/name format"
        pattern: "^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$"
      state:
        type: string
        description: "Issue state to analyze (open, closed, all)"
        enum: [open, closed, all]
        default: "open"
      similarity_threshold:
        type: number
        description: "Minimum similarity score (0-1) to consider issues related"
        default: 0.6
        minimum: 0.0
        maximum: 1.0

steps:
  - id: fetch-all-issues
    persona: github-analyst
    memory:
      strategy: fresh
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Fetch all issues from the GitHub repository for relationship analysis.

        Repository: {{ input.repo }}
        State filter: {{ input.state | default: "open" }}

        Tasks:
        1. Use gh CLI to fetch all issues matching the state filter
        2. For each issue, extract:
           - Number, title, body, labels
           - Current cross-references (issues mentioned in body)
           - Comments with issue references
        3. Organize issues for relationship analysis

        Commands:
        - gh issue list --repo {{ input.repo }} --state {{ input.state | default: "open" }} --limit 500 --json number,title,body,labels,url,comments
        - Parse for existing cross-references (#123 patterns)

        Output to artifact.json:
        {
          "repository": {
            "owner": "owner-name",
            "name": "repo-name"
          },
          "total_issues": 150,
          "issues": [
            {
              "number": 123,
              "title": "Add OAuth support",
              "body": "We need OAuth authentication...",
              "labels": ["enhancement", "authentication"],
              "url": "https://github.com/owner/repo/issues/123",
              "existing_references": [45, 67],
              "keywords": ["oauth", "authentication", "login", "token"]
            }
          ],
          "state_filter": "open",
          "timestamp": "2026-02-03T10:00:00Z"
        }
    output_artifacts:
      - name: issues_data
        path: artifact.json
        type: json
        required: true

  - id: analyze-relationships
    persona: philosopher
    dependencies: [fetch-all-issues]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: fetch-all-issues
          artifact: issues_data
          as: issues
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Analyze issues to identify relationships and potential cross-links.

        Similarity threshold: {{ input.similarity_threshold | default: 0.6 }}

        Analysis criteria:
        1. **Keyword overlap**: Shared technical terms, features, or components
        2. **Label similarity**: Common labels indicating related topics
        3. **Dependency patterns**: Issues that likely depend on or block each other
        4. **Duplicate detection**: Issues describing the same problem
        5. **Theme clustering**: Issues part of the same feature or epic

        For each pair of potentially related issues:
        - Calculate similarity score (0-1)
        - Identify relationship type: related, duplicate, depends-on, blocks, part-of
        - Note existing cross-references to avoid duplicates
        - Provide relationship rationale

        Output to artifact.json:
        {
          "total_relationships": 25,
          "relationships": [
            {
              "issue_a": 123,
              "issue_b": 125,
              "similarity_score": 0.85,
              "relationship_type": "related",
              "rationale": "Both issues discuss OAuth authentication implementation",
              "shared_keywords": ["oauth", "authentication", "token"],
              "shared_labels": ["authentication"],
              "already_linked": false,
              "priority": "high"
            },
            {
              "issue_a": 45,
              "issue_b": 123,
              "similarity_score": 0.65,
              "relationship_type": "depends-on",
              "rationale": "Issue #123 depends on infrastructure from #45",
              "shared_keywords": ["authentication", "user-management"],
              "shared_labels": ["infrastructure"],
              "already_linked": false,
              "priority": "medium"
            }
          ],
          "duplicates_found": [
            {
              "issue_a": 100,
              "issue_b": 102,
              "similarity_score": 0.95,
              "rationale": "Both report the same login timeout bug"
            }
          ],
          "similarity_threshold": {{ input.similarity_threshold | default: 0.6 }}
        }
    output_artifacts:
      - name: relationship_analysis
        path: artifact.json
        type: json
        required: true
    handover:
      contract:
        type: json_schema
        schema_path: .wave/contracts/cross-reference.schema.json
        validate: true

  - id: create-cross-links
    persona: github-enhancer
    dependencies: [analyze-relationships]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: analyze-relationships
          artifact: relationship_analysis
          as: relationships
        - step: fetch-all-issues
          artifact: issues_data
          as: issues
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Create cross-reference links between related issues.

        Repository: {{ input.repo }}

        For each identified relationship:
        1. Add a comment to link the issues bidirectionally
        2. Use appropriate relationship language:
           - "Related to #123" for general relationships
           - "Depends on #123" for dependencies
           - "Blocks #123" for blocking relationships
           - "Duplicate of #123" for duplicates (also consider closing)
           - "Part of #123" for epic/feature groupings

        3. Include the rationale in the comment
        4. Avoid duplicate links (check existing references first)

        Comment format:
        "**Related Issue**: This issue is [relationship-type] #[number]

        [Rationale for the relationship]

        _Cross-linked automatically by Wave issue relationship analysis._"

        Commands:
        - gh issue comment <issue-a> --repo {{ input.repo }} --body "[comment]"
        - For duplicates, optionally: gh issue close <duplicate> --repo {{ input.repo }} --comment "Closing as duplicate of #<original>"

        Track all links created and any errors.

        Output to artifact.json:
        {
          "links_created": [
            {
              "from_issue": 123,
              "to_issue": 125,
              "relationship_type": "related",
              "comment_posted": true,
              "bidirectional": true,
              "timestamp": "2026-02-03T10:10:00Z"
            }
          ],
          "duplicates_closed": [
            {
              "duplicate_issue": 102,
              "original_issue": 100,
              "closed": true
            }
          ],
          "total_links": 25,
          "total_errors": 0,
          "errors": []
        }
    output_artifacts:
      - name: linking_results
        path: artifact.json
        type: json
        required: true

  - id: verify-cross-links
    persona: navigator
    dependencies: [create-cross-links]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: create-cross-links
          artifact: linking_results
          as: results
        - step: analyze-relationships
          artifact: relationship_analysis
          as: relationships
    workspace:
      root: ./
    exec:
      type: prompt
      source: |
        Verify that cross-links were created successfully.

        Verification steps:
        1. For each link created, fetch the issue to verify comment exists
        2. Check that bidirectional links were created
        3. Verify duplicates were properly closed (if applicable)
        4. Confirm no links were duplicated

        Commands:
        - gh issue view <number> --repo {{ input.repo }} --json number,comments
        - Parse comments to verify cross-link comments exist

        Output to artifact.json:
        {
          "verified_links": [
            {
              "from_issue": 123,
              "to_issue": 125,
              "verified": true,
              "bidirectional": true,
              "url_a": "https://github.com/owner/repo/issues/123",
              "url_b": "https://github.com/owner/repo/issues/125"
            }
          ],
          "total_verified": 25,
          "all_successful": true,
          "verification_failures": [],
          "summary": "Successfully created 25 bidirectional cross-references between related issues. Enhanced issue discoverability and relationship tracking."
        }
    output_artifacts:
      - name: verification_report
        path: artifact.json
        type: json
        required: true
    handover:
      contract:
        type: json_schema
        schema_path: .wave/contracts/github-verification-report.schema.json
        validate: true
