{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://wave.re-cinq.com/schemas/wave-pipeline.schema.json",
  "title": "WavePipeline",
  "description": "Wave multi-agent pipeline definition",
  "type": "object",
  "required": ["kind", "metadata", "input", "steps"],
  "additionalProperties": false,
  "properties": {
    "kind": {
      "type": "string",
      "enum": ["WavePipeline"],
      "description": "Must be 'WavePipeline'"
    },
    "metadata": {
      "$ref": "#/definitions/PipelineMetadata"
    },
    "requires": {
      "$ref": "#/definitions/Requires"
    },
    "input": {
      "$ref": "#/definitions/InputConfig"
    },
    "steps": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Step"
      },
      "minItems": 1,
      "description": "Pipeline steps executed in dependency order"
    }
  },
  "definitions": {
    "PipelineMetadata": {
      "type": "object",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique pipeline name (used for workspace paths, CLI references)"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what this pipeline does"
        },
        "release": {
          "type": "boolean",
          "default": false,
          "description": "Whether this pipeline is ready for release use"
        },
        "disabled": {
          "type": "boolean",
          "default": false,
          "description": "Disables the pipeline from being executed"
        }
      }
    },
    "Requires": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "skills": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Skill names that must be installed before execution"
        },
        "tools": {
          "type": "array",
          "items": { "type": "string" },
          "description": "CLI tools that must be available on PATH"
        }
      }
    },
    "InputConfig": {
      "type": "object",
      "required": ["source"],
      "additionalProperties": false,
      "properties": {
        "source": {
          "type": "string",
          "enum": ["cli", "github_issues", "file"],
          "description": "Where pipeline input comes from"
        },
        "schema": {
          "$ref": "#/definitions/InputSchema"
        },
        "example": {
          "type": "string",
          "description": "Example input for documentation and testing"
        },
        "label_filter": {
          "type": "string",
          "description": "Label filter for GitHub issue sources"
        },
        "batch_size": {
          "type": "integer",
          "minimum": 1,
          "description": "Batch size for multi-item sources"
        }
      }
    },
    "InputSchema": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Input type (e.g., 'string', 'json')"
        },
        "description": {
          "type": "string",
          "description": "Description of the expected input format"
        }
      }
    },
    "Step": {
      "type": "object",
      "required": ["id", "persona", "exec"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique step identifier (lowercase, hyphens allowed)"
        },
        "persona": {
          "type": "string",
          "description": "Persona name from wave.yaml manifest"
        },
        "dependencies": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Step IDs that must complete before this step runs"
        },
        "memory": {
          "$ref": "#/definitions/MemoryConfig"
        },
        "workspace": {
          "$ref": "#/definitions/WorkspaceConfig"
        },
        "exec": {
          "$ref": "#/definitions/ExecConfig"
        },
        "output_artifacts": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ArtifactDef"
          },
          "description": "Files produced by this step for downstream consumption"
        },
        "outcomes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/OutcomeDef"
          },
          "description": "Structured outcomes to extract from step artifacts for display in the pipeline summary"
        },
        "handover": {
          "$ref": "#/definitions/HandoverConfig"
        },
        "strategy": {
          "$ref": "#/definitions/MatrixStrategy"
        },
        "validation": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ValidationRule"
          }
        },
        "outcomes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/OutcomeDef"
          },
          "description": "Structured outcomes to extract from step artifacts for the pipeline summary"
        }
      }
    },
    "MemoryConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["fresh"],
          "default": "fresh",
          "description": "Memory strategy â€” defaults to 'fresh' (no chat history inheritance)"
        },
        "inject_artifacts": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ArtifactRef"
          },
          "description": "Artifacts from prior steps to inject into workspace"
        }
      }
    },
    "ArtifactRef": {
      "type": "object",
      "required": ["step", "artifact", "as"],
      "additionalProperties": false,
      "properties": {
        "step": {
          "type": "string",
          "description": "ID of the step that produced the artifact"
        },
        "artifact": {
          "type": "string",
          "description": "Name of the output artifact"
        },
        "as": {
          "type": "string",
          "description": "Name to mount the artifact under artifacts/ directory"
        },
        "type": {
          "type": "string",
          "enum": ["json", "text", "markdown", "binary"],
          "description": "Expected artifact type for validation"
        },
        "schema_path": {
          "type": "string",
          "description": "Path to JSON schema file for input content validation"
        },
        "optional": {
          "type": "boolean",
          "default": false,
          "description": "If true, missing artifact doesn't fail the step"
        }
      }
    },
    "WorkspaceConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "root": {
          "type": "string",
          "description": "Workspace root directory (e.g., './' for project root)"
        },
        "mount": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Mount"
          },
          "description": "Filesystem mounts into the workspace"
        },
        "type": {
          "type": "string",
          "enum": ["worktree", ""],
          "description": "Workspace type: 'worktree' for git worktree isolation, empty for directory"
        },
        "branch": {
          "type": "string",
          "description": "Branch name for worktree workspaces (supports {{ pipeline_id }} template)"
        }
      }
    },
    "Mount": {
      "type": "object",
      "required": ["source", "target"],
      "additionalProperties": false,
      "properties": {
        "source": {
          "type": "string",
          "description": "Source path (relative to project root)"
        },
        "target": {
          "type": "string",
          "description": "Target path inside the workspace"
        },
        "mode": {
          "type": "string",
          "enum": ["readonly", "readwrite"],
          "default": "readwrite",
          "description": "Mount access mode"
        }
      }
    },
    "ExecConfig": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["prompt", "command", "slash_command"],
          "description": "Execution type"
        },
        "source": {
          "type": "string",
          "description": "Inline prompt content (for type: prompt)"
        },
        "source_path": {
          "type": "string",
          "description": "Path to external prompt file (for type: prompt)"
        },
        "command": {
          "type": "string",
          "description": "Slash command name (for type: slash_command)"
        },
        "args": {
          "type": "string",
          "description": "Arguments for slash command"
        }
      }
    },
    "ArtifactDef": {
      "type": "object",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Artifact name (referenced by inject_artifacts)"
        },
        "path": {
          "type": "string",
          "description": "File path relative to workspace root (optional when source is stdout)"
        },
        "type": {
          "type": "string",
          "enum": ["json", "text", "markdown", "binary"],
          "description": "Artifact content type"
        },
        "required": {
          "type": "boolean",
          "default": false,
          "description": "Whether this artifact must exist after step completion"
        },
        "source": {
          "type": "string",
          "enum": ["file", "stdout"],
          "default": "file",
          "description": "Artifact source: 'file' (persona writes file) or 'stdout' (captured from process output)"
        }
      }
    },
    "HandoverConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "contract": {
          "$ref": "#/definitions/ContractConfig"
        },
        "compaction": {
          "$ref": "#/definitions/CompactionConfig"
        },
        "on_review_fail": {
          "type": "string",
          "enum": ["retry", "fail", "skip"],
          "description": "Action when review fails"
        },
        "target_step": {
          "type": "string",
          "description": "Target step for review failure routing"
        },
        "max_retries": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum retry attempts on handover failure"
        }
      }
    },
    "ContractConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["json_schema", "test_suite", "typescript_interface", "markdown_spec", "template", "format"],
          "description": "Contract validation type"
        },
        "schema": {
          "type": "string",
          "description": "Inline schema content"
        },
        "source": {
          "type": "string",
          "description": "Path to the file to validate"
        },
        "schema_path": {
          "type": "string",
          "description": "Path to the JSON Schema file"
        },
        "validate": {
          "type": "boolean",
          "description": "Whether to enable validation"
        },
        "command": {
          "type": "string",
          "description": "Test command (for type: test_suite)"
        },
        "dir": {
          "type": "string",
          "description": "Working directory: 'project_root', absolute path, or empty for workspace"
        },
        "must_pass": {
          "type": "boolean",
          "description": "Whether validation failure blocks the pipeline"
        },
        "on_failure": {
          "type": "string",
          "enum": ["retry", "fail"],
          "description": "Action on validation failure"
        },
        "max_retries": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum retry attempts"
        },
        "progressive_validation": {
          "type": "boolean",
          "description": "Enable progressive validation with warnings"
        },
        "recovery_level": {
          "type": "string",
          "enum": ["conservative", "progressive", "aggressive"],
          "description": "JSON recovery aggressiveness"
        },
        "allow_recovery": {
          "type": "boolean",
          "description": "Enable automatic JSON recovery"
        }
      }
    },
    "CompactionConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "trigger": {
          "type": "string",
          "description": "Compaction trigger (e.g., 'token_limit_80%')"
        },
        "persona": {
          "type": "string",
          "description": "Persona to use for summarization"
        }
      }
    },
    "MatrixStrategy": {
      "type": "object",
      "required": ["type", "items_source", "item_key"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Strategy type"
        },
        "items_source": {
          "type": "string",
          "description": "Source of items for matrix expansion"
        },
        "item_key": {
          "type": "string",
          "description": "Key name for individual items"
        },
        "max_concurrency": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum parallel executions"
        }
      }
    },
    "OutcomeDef": {
      "type": "object",
      "required": ["type", "extract_from", "json_path"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["pr", "issue", "url", "deployment"],
          "description": "Outcome type for display categorization"
        },
        "extract_from": {
          "type": "string",
          "description": "Path to artifact file relative to workspace (e.g., 'output/publish-result.json')"
        },
        "json_path": {
          "type": "string",
          "description": "Dot-notation path to extract value (e.g., '.comment_url')"
        },
        "label": {
          "type": "string",
          "description": "Human-readable label for the outcome"
        }
      }
    },
    "OutcomeDef": {
      "type": "object",
      "required": ["type", "extract_from", "json_path"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["pr", "issue", "url", "deployment", "comment"],
          "description": "Outcome type, determines how it is displayed in the summary"
        },
        "extract_from": {
          "type": "string",
          "description": "Path to JSON artifact relative to workspace (e.g., 'output/publish-result.json')"
        },
        "json_path": {
          "type": "string",
          "description": "Dot-notation path to extract value from JSON (e.g., '.comment_url')"
        },
        "label": {
          "type": "string",
          "description": "Human-readable label for display in the outcome summary"
        }
      }
    },
    "ValidationRule": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Validation rule type"
        },
        "target": {
          "type": "string",
          "description": "Target to validate"
        },
        "schema": {
          "type": "string",
          "description": "Schema for validation"
        },
        "on_failure": {
          "type": "string",
          "enum": ["retry", "fail"],
          "description": "Action on failure"
        },
        "max_retries": {
          "type": "integer",
          "minimum": 0
        }
      }
    }
  }
}
