kind: WavePipeline
metadata:
  name: speckit-flow
  description: "Specification-driven feature development using the full speckit workflow"
  release: false

input:
  source: cli
  example: "add user authentication with JWT tokens"
  schema:
    type: string
    description: "Natural language feature description to specify and implement"

steps:
  - id: specify
    persona: implementer
    memory:
      strategy: fresh
    workspace:
      root: ./
    exec:
      type: prompt
      source_path: .wave/prompts/speckit-flow/specify.md
    output_artifacts:
      - name: spec-status
        path: output/specify-status.json
        type: json

  - id: clarify
    persona: implementer
    dependencies: [specify]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: specify
          artifact: spec-status
          as: spec_info
    workspace:
      root: ./
    exec:
      type: prompt
      source_path: .wave/prompts/speckit-flow/clarify.md
    output_artifacts:
      - name: clarify-status
        path: output/clarify-status.json
        type: json

  - id: plan
    persona: implementer
    dependencies: [clarify]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: specify
          artifact: spec-status
          as: spec_info
    workspace:
      root: ./
    exec:
      type: prompt
      source_path: .wave/prompts/speckit-flow/plan.md
    output_artifacts:
      - name: plan-status
        path: output/plan-status.json
        type: json

  - id: tasks
    persona: implementer
    dependencies: [plan]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: specify
          artifact: spec-status
          as: spec_info
    workspace:
      root: ./
    exec:
      type: prompt
      source_path: .wave/prompts/speckit-flow/tasks.md
    output_artifacts:
      - name: tasks-status
        path: output/tasks-status.json
        type: json

  - id: checklist
    persona: implementer
    dependencies: [tasks]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: specify
          artifact: spec-status
          as: spec_info
    workspace:
      root: ./
    exec:
      type: prompt
      source_path: .wave/prompts/speckit-flow/checklist.md
    output_artifacts:
      - name: checklist-status
        path: output/checklist-status.json
        type: json

  - id: analyze
    persona: implementer
    dependencies: [checklist]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: specify
          artifact: spec-status
          as: spec_info
    workspace:
      root: ./
    exec:
      type: prompt
      source_path: .wave/prompts/speckit-flow/analyze.md
    output_artifacts:
      - name: analysis-report
        path: output/analysis-report.json
        type: json

  - id: implement
    persona: craftsman
    dependencies: [analyze]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: specify
          artifact: spec-status
          as: spec_info
    workspace:
      root: ./
    exec:
      type: prompt
      source_path: .wave/prompts/speckit-flow/implement.md
    handover:
      contract:
        type: test_suite
        command: "{{ project.test_command }}"
        must_pass: true
        on_failure: retry
        max_retries: 3
      compaction:
        trigger: "token_limit_80%"
        persona: summarizer

  - id: create-pr
    persona: craftsman
    dependencies: [implement]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: specify
          artifact: spec-status
          as: spec_info
    workspace:
      root: ./
    exec:
      type: prompt
      source_path: .wave/prompts/speckit-flow/create-pr.md
    output_artifacts:
      - name: pr-result
        path: output/pr-result.json
        type: json
