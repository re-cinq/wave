kind: WavePipeline
metadata:
  name: migrate
  description: "Database or API migration with rollback plan"
  disabled: true

input:
  source: cli

steps:
  - id: impact-analysis
    persona: navigator
    memory:
      strategy: fresh
    workspace:
      mount:
        - source: ./
          target: /src
          mode: readonly
    exec:
      type: prompt
      source: |
        Analyze migration impact for: {{ input }}

        1. Identify all code using the affected schema/API
        2. Map data flow and transformations
        3. Find breaking changes for consumers
        4. Estimate data volume and migration time

        Output as JSON:
        {
          "affected_code": [],
          "breaking_changes": [],
          "data_transformations": [],
          "estimated_downtime": "",
          "rollback_complexity": "easy|medium|hard"
        }
    output_artifacts:
      - name: impact
        path: output/impact-analysis.json
        type: json

  - id: migration-plan
    persona: philosopher
    dependencies: [impact-analysis]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: impact-analysis
          artifact: impact
          as: analysis
    exec:
      type: prompt
      source: |
        Create a migration plan for: {{ input }}

        Include:
        1. Pre-migration checklist
        2. Step-by-step migration procedure
        3. Data validation queries
        4. Rollback procedure for each step
        5. Communication plan for consumers
        6. Monitoring and alerting setup

        Prefer zero-downtime migrations where possible.
    output_artifacts:
      - name: plan
        path: output/migration-plan.md
        type: markdown

  - id: implement
    persona: craftsman
    dependencies: [migration-plan]
    memory:
      strategy: fresh
      inject_artifacts:
        - step: migration-plan
          artifact: plan
          as: migration_plan
    workspace:
      mount:
        - source: ./
          target: /src
          mode: readwrite
    exec:
      type: prompt
      source: |
        Implement the migration:

        1. Write migration scripts (up and down)
        2. Update application code for new schema/API
        3. Add feature flags if needed for gradual rollout
        4. Write validation tests
        5. Update documentation

        Ensure rollback scripts are tested.
    # handover:
    #   contract:
    #     type: test_suite
    #     command: "npm test"  # or: go test ./..., pytest, cargo test
    #     must_pass: false
    #     on_failure: retry
    #     max_retries: 2

  - id: review
    persona: auditor
    dependencies: [implement]
    memory:
      strategy: fresh
    exec:
      type: prompt
      source: |
        Review the migration implementation:

        1. Are up/down migrations symmetric?
        2. Is data loss possible? How is it prevented?
        3. Are there race conditions during migration?
        4. Is the rollback tested and working?
        5. Are consumers properly notified?

        Output: GO / NO-GO recommendation with reasoning
    output_artifacts:
      - name: review
        path: output/migration-review.md
        type: markdown
