# Implementation Plan: Stream Verbosity

**Branch**: `026-stream-verbosity` | **Date**: 2026-02-09 | **Spec**: `specs/026-stream-verbosity/spec.md`
**Input**: Feature specification from `specs/026-stream-verbosity/spec.md`

## Summary

Add display-layer throttling, extended tool target extraction, step-start metadata, and ETA field plumbing to Wave's existing streaming adapter infrastructure. The codebase already implements ~70-75% of the stream verbosity spec (streaming with `stream-json`, NDJSON parsing, tool extraction for 7 tools, event bridge wiring, result accumulation). This plan targets the remaining gaps: FR-006 (throttled display), FR-009 extension (3 new tools + generic heuristic), FR-010 (model/adapter in step-start events), FR-011 (ETA zero-value plumbing), plus comprehensive test coverage for both existing and new functionality.

## Technical Context

**Language/Version**: Go 1.25+ (existing Wave project)
**Primary Dependencies**: gopkg.in/yaml.v3, github.com/spf13/cobra (existing), sync (stdlib), time (stdlib)
**Storage**: N/A for this feature (ETA duration history deferred to future iteration)
**Testing**: `go test ./... -race` (standard Go testing with race detector)
**Target Platform**: Linux/macOS (single static binary)
**Project Type**: Single Go binary — multi-agent pipeline orchestrator
**Performance Goals**: Tool call events visible within 1 second of subprocess emission; display rendering at most 1 event/second during bursts
**Constraints**: No new dependencies; maintain backward compatibility of final results; no changes to `AdapterRunner` interface
**Scale/Scope**: 6 files modified/created; ~200-300 lines of new code + ~300 lines of tests

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| # | Principle | Status | Notes |
|---|-----------|--------|-------|
| 1 | Single Binary, Minimal Dependencies | PASS | No new dependencies. `ThrottledProgressEmitter` uses stdlib only (`sync`, `time`). |
| 2 | Manifest as Single Source of Truth | PASS | No manifest changes. Adapter and persona config unchanged. |
| 3 | Persona-Scoped Execution Boundaries | PASS | No permission model changes. Stream events carry persona context but do not modify execution boundaries. |
| 4 | Fresh Memory at Every Step Boundary | PASS | No change to context isolation. Stream events are ephemeral — they do not persist across step boundaries. |
| 5 | Navigator-First Architecture | PASS | Not affected. Streaming is an observability feature, not a workflow change. |
| 6 | Contracts at Every Handover | PASS | Result accumulation (FR-004) unchanged. Contract validation still receives complete adapter output. |
| 7 | Relay via Dedicated Summarizer | PASS | Not affected. Streaming does not change compaction behavior. |
| 8 | Ephemeral Workspaces for Safety | PASS | Not affected. No workspace changes. |
| 9 | Credentials Never Touch Disk | PASS | Stream events contain tool names and targets (file paths, commands) but never credentials. Event schema has no credential fields. |
| 10 | Observable Progress, Auditable Operations | PASS | **Enhanced.** This feature directly improves observability by surfacing real-time tool activity through structured events. |
| 11 | Bounded Recursion and Resource Limits | PASS | Throttling adds bounded resource usage. The 1-second coalescing window prevents unbounded event rendering. |
| 12 | Minimal Step State Machine | PASS | No new states added. `stream_activity` is an event state for observability, not a step lifecycle state. The 5-state machine remains unchanged. |
| 13 | Test Ownership for Core Primitives | PASS | Plan includes comprehensive test coverage. All existing tests must continue to pass. New tests added for all new code paths. |

**No violations. No complexity tracking entries required.**

## Project Structure

### Documentation (this feature)

```
specs/026-stream-verbosity/
├── plan.md              # This file
├── research.md          # Phase 0 output: technology decisions
├── data-model.md        # Phase 1 output: entity definitions and relationships
├── spec.md              # Feature specification (input)
├── checklists/
│   └── requirements.md  # Quality validation checklist
├── contracts/
│   ├── throttled-emitter.md      # ThrottledProgressEmitter behavioral contract
│   ├── tool-target-extraction.md # extractToolTarget function contract
│   ├── step-start-event.md       # Step-start event schema contract
│   └── progress-event.md         # Progress event schema contract (ETA field)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```
internal/
├── adapter/
│   ├── claude.go              # MODIFY: extend extractToolTarget() with 3 tools + heuristic
│   └── claude_test.go         # MODIFY: add table-driven tests for tool target extraction
├── event/
│   └── emitter.go             # MODIFY: add Model, Adapter fields to Event struct
├── display/
│   ├── throttled_emitter.go       # NEW: ThrottledProgressEmitter implementation
│   └── throttled_emitter_test.go  # NEW: throttle coalescing tests
└── pipeline/
    └── executor.go            # MODIFY: populate Model and Adapter in step-start event
```

**Files unchanged** (verified during research):
- `internal/adapter/adapter.go` — StreamEvent and AdapterRunConfig already correct
- `internal/display/progress.go` — throttling handled by wrapper, not display modifications
- `internal/display/bubbletea_progress.go` — already handles stream_activity in verbose mode
- `internal/display/types.go` — PipelineContext already has LastToolName/LastToolTarget

**Structure Decision**: Single Go project. All changes are within the existing `internal/` package structure. One new file (`throttled_emitter.go`) and one new test file. No new packages needed.

## Implementation Phases

### Phase A: Extended Tool Target Extraction (FR-009)

**Scope**: Extend `extractToolTarget()` in `internal/adapter/claude.go` (lines 420-449).

**Changes**:
1. Add three explicit `case` entries to the existing `switch`:
   - `WebFetch` → `url` field
   - `WebSearch` → `query` field
   - `NotebookEdit` → `notebook_path` field
2. Replace the empty `default` return with a generic heuristic that checks common field names in priority order: `file_path`, `url`, `pattern`, `command`, `query`, `notebook_path`
3. Return the first non-empty match; empty string if none found

**Tests** (`internal/adapter/claude_test.go`):
- Table-driven `TestExtractToolTarget` covering all 10 explicit tools
- Heuristic fallback tests: unknown tool with `file_path`, unknown tool with `url`, unknown tool with no matching fields
- Nil/empty input edge cases

**Risk**: Low. Self-contained function change with no side effects.

### Phase B: Step-Start Metadata (FR-010)

**Scope**: Add `Model` and `Adapter` fields to `Event` struct and populate them in step-start events.

**Changes**:
1. `internal/event/emitter.go`: Add two fields to `Event` struct:
   ```go
   Model   string `json:"model,omitempty"`
   Adapter string `json:"adapter,omitempty"`
   ```
2. `internal/pipeline/executor.go`: Populate these fields in the step-start event emission (around line 382-390), sourcing from the adapter run config's `Model` and adapter definition.

**Tests**:
- Verify step-start events include Model and Adapter in NDJSON output
- Verify fields are omitted when empty (omitempty behavior)

**Risk**: Low. Two optional fields with omitempty. No breaking changes to existing consumers.

### Phase C: Throttled Display Rendering (FR-006)

**Scope**: Create `ThrottledProgressEmitter` wrapper in `internal/display/`.

**Changes**:
1. New file `internal/display/throttled_emitter.go`:
   - Implements `ProgressEmitter` interface
   - 1-second sliding window for `stream_activity` events (most-recent-wins coalescing)
   - Immediate passthrough for all other event types
   - `sync.Mutex` for thread safety
   - Flush pending event when non-stream-activity event arrives
2. Wire the wrapper where `ProgressEmitter` instances are created:
   - In `cmd/wave/commands/` where NDJSONEmitter is configured with a progress emitter, wrap the inner display with `NewThrottledProgressEmitter()`

**Tests** (`internal/display/throttled_emitter_test.go`):
- First event passes through immediately
- Events within 1-second window are coalesced (only most recent forwarded)
- Non-stream-activity events pass through immediately regardless of throttle state
- Concurrent access test (run with `-race`)
- Pending event flushed when non-stream-activity event arrives
- Configurable interval (test with short interval for fast tests)

**Risk**: Medium. Timing-dependent tests require careful design (use configurable interval with short durations for test reliability). Thread safety requires mutex.

### Phase D: ETA Field Plumbing (FR-011)

**Scope**: Ensure `EstimatedTimeMs` appears in progress heartbeat events.

**Changes**:
1. `internal/pipeline/executor.go`: In progress heartbeat emission (around lines 229-237 and the progress ticker), ensure `EstimatedTimeMs: 0` is explicitly set. Since the field already exists in the Event struct, this may already work via zero-value semantics — verify and document.

**Tests**:
- Verify heartbeat events include `EstimatedTimeMs` field (as 0)
- Verify the field is present in NDJSON output (note: this may require removing `omitempty` from the field if zero should be explicitly present per the progress-event contract)

**Risk**: Very low. Schema field already exists. Minimal code change.

### Phase E: Existing Code Audit & Test Coverage

**Scope**: Add test coverage for existing streaming functionality that currently lacks tests.

**Tests to add**:
1. `TestParseStreamLine` — all event types: system, assistant/tool_use, assistant/text, tool_result, result
2. `TestStreamEventCallback` — verify OnStreamEvent callback is invoked with correct StreamEvent fields
3. `TestStreamActivityEventBridge` — verify executor enriches events with pipeline context
4. `TestMalformedLineHandling` — verify malformed NDJSON lines are skipped (FR-008)

**Risk**: Low. Read-only verification of existing behavior. No code changes to production code.

## Complexity Tracking

_No constitution violations. No complexity justifications required._

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|-----------|--------------------------------------|
| (none)    | —         | —                                    |
