# Implementation Plan: Pipeline Failure Mode Test Coverage

**Branch**: `114-pipeline-failure-tests` | **Date**: 2026-02-20 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/114-pipeline-failure-tests/spec.md`

## Summary

Implement comprehensive integration tests covering all seven pipeline failure modes specified in Issue #114:
1. Contract schema mismatch detection
2. Step timeout handling with process group termination
3. Missing artifact detection (requires implementation fix)
4. Permission denial enforcement
5. Workspace corruption recovery
6. Non-zero adapter exit code handling
7. Contract validator false-positive prevention

The implementation follows a TDD approach where tests drive necessary implementation fixes, particularly for missing artifact accumulation. Target: 80% statement coverage for `internal/contract/` and `internal/pipeline/` packages.

## Technical Context

**Language/Version**: Go 1.25+
**Primary Dependencies**: `gopkg.in/yaml.v3` (config), `github.com/spf13/cobra` (CLI), `github.com/santhosh-tekuri/jsonschema/v6` (JSON Schema)
**Storage**: SQLite for pipeline state, filesystem for workspaces/artifacts
**Testing**: `go test`, `go test -race`, `go test -cover`, `go test -tags=integration`
**Target Platform**: Linux (primary), macOS (secondary)
**Project Type**: Single Go binary with internal packages
**Performance Goals**: Individual tests under 30 seconds, full suite under 10 minutes (SC-007)
**Constraints**: No external test infrastructure required; tests must work in CI environment
**Scale/Scope**: ~50-70 new test cases across 3-4 packages

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle | Status | Notes |
|-----------|--------|-------|
| P1: Single Binary | ✅ Pass | No new dependencies; tests use existing infrastructure |
| P2: Manifest as SSOT | ✅ Pass | No manifest changes required |
| P3: Persona-Scoped Execution | ✅ Pass | Tests verify permission enforcement |
| P4: Fresh Memory | ✅ Pass | Tests don't affect memory model |
| P5: Navigator-First | ✅ Pass | Tests verify pipeline structure, not changing it |
| P6: Contracts at Handovers | ✅ Pass | Tests strengthen contract validation |
| P7: Relay via Summarizer | ✅ Pass | Not affected |
| P8: Ephemeral Workspaces | ✅ Pass | Tests use `t.TempDir()` |
| P9: Credentials Never Touch Disk | ✅ Pass | No credential handling in tests |
| P10: Observable Progress | ✅ Pass | Tests verify event emission |
| P11: Bounded Recursion | ✅ Pass | Not affected |
| P12: Minimal State Machine | ✅ Pass | Tests verify state transitions |
| P13: Test Ownership | ✅ Pass | This feature IS the test ownership implementation |

**Post-Phase 1 Re-check**: All principles remain satisfied. The implementation fix for artifact injection is a bug fix, not a design change.

## Project Structure

### Documentation (this feature)

```
specs/114-pipeline-failure-tests/
├── plan.md              # This file
├── research.md          # Phase 0 analysis of existing tests and gaps
├── data-model.md        # Key entities: ValidationError, StepError, AdapterResult
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (affected paths)

```
internal/
├── contract/
│   ├── contract.go           # ValidationError, ContractConfig (existing)
│   ├── contract_test.go      # +false-positive tests, boundary conditions
│   ├── jsonschema.go         # JSON Schema validator (existing)
│   ├── jsonschema_test.go    # NEW: Malformed JSON, type coercion tests
│   └── testsuite_test.go     # +exit code verification
├── pipeline/
│   ├── executor.go           # injectArtifacts() FIX: accumulate missing
│   ├── executor_test.go      # +artifact injection failure tests
│   ├── error_handling_integration_test.go  # +new scenarios
│   └── workspace_validation_test.go  # NEW: corruption detection
├── adapter/
│   ├── adapter.go            # killProcessGroup (existing, 3s grace period)
│   ├── adapter_test.go       # +child process group verification
│   └── errors_test.go        # +SIGKILL (137) classification
└── workspace/
    └── workspace_test.go     # +boundary validation tests

tests/
└── integration/
    └── failure_modes_test.go # NEW: Named pipeline integration tests
```

**Structure Decision**: Existing Go package structure. Tests added to existing `*_test.go` files where possible; new files only for logically distinct test suites.

## Implementation Phases

### Phase 1: Contract Package Tests (Target: 80% coverage)

**Current**: 53.6% → **Target**: 80%

Files to modify:
- `internal/contract/contract_test.go`: Add boundary value tests, JSON coercion prevention
- `internal/contract/jsonschema_test.go` (NEW): Malformed JSON rejection tests
- `internal/contract/testsuite_test.go`: Add exit code verification tests

Test scenarios:
- US1.1: Type mismatch detection (string vs integer)
- US1.2: Missing required fields
- US1.3: additionalProperties: false
- US7.1: Array vs object coercion
- US7.2: Boundary conditions (minimum: 1)
- US7.3: Malformed JSON (trailing commas)
- US7.4: Test suite exit code checking

### Phase 2: Artifact Injection Fix + Tests

**Implementation required**: `injectArtifacts()` must accumulate all missing artifacts

Files to modify:
- `internal/pipeline/executor.go`: Fix silent artifact failure
- `internal/pipeline/executor_test.go`: Add missing artifact tests

Test scenarios:
- US3.1: Single missing artifact detection
- US3.2: Multiple missing artifacts (all reported)
- US3.3: Directory instead of file error

### Phase 3: Adapter/Timeout Tests

**Current timeout tests exist**; add child process verification.

Files to modify:
- `internal/adapter/adapter_test.go`: Child process group termination
- `internal/adapter/errors_test.go`: SIGKILL (137) classification

Test scenarios:
- US2.1: Basic timeout with SIGTERM → SIGKILL
- US2.2: Child process cleanup verification
- US2.3: Timeout during retry
- US6.1: Exit code 1 detection
- US6.2: Exit code precedence over partial output
- US6.3: SIGKILL (137) detection

### Phase 4: Pipeline Package Tests (Target: 80% coverage)

**Current**: 65.8% → **Target**: 80%

Files to modify/create:
- `internal/pipeline/error_handling_integration_test.go`: Add scenarios
- `internal/pipeline/workspace_validation_test.go` (NEW): Corruption detection

Test scenarios:
- US4.1: Permission denial enforcement (via mock)
- US5.1: Workspace directory deletion detection
- US5.2: Read-only workspace error
- US5.3: Disk space error messaging

### Phase 5: Named Pipeline Integration Tests

Files to create:
- `tests/integration/failure_modes_test.go`

Pipelines to test (at least 3 per SC-005):
1. `speckit-flow`: Contract failures, multi-step coordination
2. `gh-issue-implement`: Workspace isolation, worktree handling
3. `gh-issue-rewrite`: Exit code handling, artifact flow

Edge cases:
- Concurrent step failures (collect all, not just first)
- Retry exhaustion with clear state indication
- Context cancellation (SIGINT) graceful shutdown
- Empty artifact (0 bytes) vs missing artifact
- Circular dependency detection at load time
- UTF-8 artifact paths and content

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|--------------------------------------|
| Implementation fix in executor.go | CL-003 mandates TDD: test drives implementation | Adding test without fix would create permanently failing test |

## Dependencies

- No new external dependencies
- Uses existing test infrastructure (`testing`, `t.TempDir()`)
- Integration tests may use `adapter.NewMockAdapter()` for determinism

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Coverage gap (26.4% for contract) | May not reach 80% | Focus on high-value failure paths first |
| Permission denial requires adapter behavior | Tests may be flaky | Use mock adapter for permission tests |
| Workspace corruption simulation | Complex test setup | Use `os.Chmod`, `os.Remove` in test hooks |

## Success Criteria Checklist

- [ ] SC-001: All 7 failure scenarios have tests
- [ ] SC-002: `internal/contract/` ≥ 80% coverage
- [ ] SC-003: `internal/pipeline/` ≥ 80% coverage
- [ ] SC-004: `go test -race ./...` passes
- [ ] SC-005: Integration tests for 3+ named pipelines
- [ ] SC-006: No false-positive scenarios
- [ ] SC-007: All tests < 30s individual, < 10min total
